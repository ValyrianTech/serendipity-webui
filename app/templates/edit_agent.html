{% extends "base.html" %}

{% block title %}Edit {{ agent_name }} - Serendipity{% endblock %}

{% block content %}
<div class="flex flex-col h-full">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-slate-700">
        <div class="flex items-center gap-4">
            <a href="/agent/{{ agent_name }}" class="text-slate-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1 class="text-xl font-bold">Edit Agent: <span id="agent-title">{{ agent_name }}</span></h1>
        </div>
        <button onclick="saveAgent()" class="btn-primary flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Save Changes
        </button>
    </div>
    
    <!-- Loading -->
    <div id="loading" class="flex-1 flex items-center justify-center">
        <div class="spinner"></div>
    </div>
    
    <!-- Form -->
    <div id="edit-form" class="flex-1 overflow-y-auto p-6 hidden">
        <div class="max-w-4xl mx-auto space-y-6">
            <!-- Basic Info -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Basic Information</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Profile Picture -->
                    <div class="flex flex-col items-center">
                        <img id="profile-preview" src="" alt="Profile" 
                             class="w-48 h-48 rounded-full object-cover bg-slate-700 mb-4">
                        <div class="w-full space-y-2">
                            <input type="text" id="profile-picture" placeholder="Profile picture URL"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm">
                            <label class="btn-secondary w-full flex items-center justify-center gap-2 cursor-pointer">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                Upload Image
                                <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="uploadProfilePicture(this)">
                            </label>
                        </div>
                    </div>
                    
                    <!-- Name and Description -->
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Agent Name</label>
                            <input type="text" id="agent-name" readonly
                                   class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-slate-400">
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Description</label>
                            <textarea id="description" rows="3" placeholder="Agent description..."
                                      class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2"></textarea>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">User Name</label>
                            <input type="text" id="user-name" placeholder="Default user name"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Model Settings -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Model Settings</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-sm text-slate-400 block mb-2">Model</label>
                        <select id="model-name" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                            <option value="">Loading models...</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 block mb-2">Temperature: <span id="temp-value">0.0</span></label>
                        <input type="range" id="temperature" min="0" max="2" step="0.1" value="0"
                               class="w-full" oninput="document.getElementById('temp-value').textContent = this.value">
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 block mb-2">Memory: <span id="memory-value">0</span></label>
                        <input type="range" id="memory" min="0" max="100" step="1" value="0"
                               class="w-full" oninput="document.getElementById('memory-value').textContent = this.value">
                    </div>
                </div>
            </div>
            
            <!-- System Message -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">System Message</h2>
                <textarea id="system-message" rows="6" placeholder="System message for the agent..."
                          class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 font-mono text-sm"></textarea>
            </div>
            
            <!-- Bootup Message -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Bootup Message</h2>
                <textarea id="bootup-message" rows="4" placeholder="Message sent when agent starts..."
                          class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 font-mono text-sm"></textarea>
            </div>
            
            <!-- Tools -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Tools</h2>
                <div id="tools-list" class="flex flex-wrap gap-2 mb-4"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-tool" placeholder="Add new tool..."
                           class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <button onclick="addTool()" class="btn-secondary">Add</button>
                </div>
            </div>
            
            <!-- Auto-Allow Tools -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Auto-Allow Tools</h2>
                <div id="auto-allow-tools-list" class="flex flex-wrap gap-2 mb-4"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-auto-allow-tool" placeholder="Add auto-allow tool..."
                           class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <button onclick="addAutoAllowTool()" class="btn-secondary">Add</button>
                </div>
            </div>
            
            <!-- Toolsets -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Toolsets</h2>
                <input type="text" id="toolsets" placeholder="Comma-separated toolset names..."
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
            </div>
            
            <!-- Participants -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Participants</h2>
                <div id="participants-list" class="flex flex-wrap gap-2 mb-4"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-participant" placeholder="Add participant..."
                           class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <button onclick="addParticipant()" class="btn-secondary">Add</button>
                </div>
            </div>
            
            <!-- Order of Speakers -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Order of Speakers</h2>
                <div id="speakers-list" class="space-y-2 mb-4"></div>
                <p class="text-sm text-slate-400">Drag items to reorder. Use the handle on the left.</p>
            </div>
            
            <!-- Voices -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Voices</h2>
                <div id="voices-list" class="flex flex-wrap gap-2 mb-4"></div>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="new-voice" placeholder="voice_name:filename.mp3"
                           class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <button onclick="addVoice()" class="btn-secondary">Add</button>
                </div>
                <label class="btn-secondary inline-flex items-center gap-2 cursor-pointer">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <span>Upload Voice File</span>
                    <input type="file" id="voice-upload" accept="audio/*" class="hidden" onchange="uploadVoiceFile(this)">
                </label>
                <p class="text-xs text-slate-500 mt-2">Format: voice_name:filename.mp3 (e.g., "narrator:voice1.mp3")</p>
            </div>
            
            <!-- Roles -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Roles</h2>
                <div id="roles-list" class="space-y-3 mb-4"></div>
                <button onclick="showAddRoleModal()" class="btn-secondary">Add Role</button>
            </div>
            
            <!-- Flags -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Flags</h2>
                <div class="flex gap-6">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="serendipity-flag" class="w-5 h-5 rounded">
                        <span>SERENDIPITY</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="public-flag" class="w-5 h-5 rounded">
                        <span>Public</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Role Modal -->
<div id="add-role-modal" class="modal-backdrop hidden">
    <div class="modal-content">
        <h2 id="role-modal-title" class="text-xl font-bold mb-4">Add Role</h2>
        <div class="space-y-4">
            <div>
                <label class="text-sm text-slate-400 block mb-2">Role Name</label>
                <input type="text" id="role-name" placeholder="Role name..."
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
            </div>
            <div>
                <label class="text-sm text-slate-400 block mb-2">Role Prompt</label>
                <textarea id="role-system-message" rows="6" placeholder="System prompt for this role..."
                          class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2"></textarea>
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="saveRole()" class="btn-primary flex-1">Save Role</button>
            <button onclick="closeAddRoleModal()" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script type="module">
    import { getAgent, getModels, editAgent, editAgentRole, uploadFile, getSettings } from '/static/js/api.js';
    
    const agentName = '{{ agent_name }}';
    let agentData = null;
    let tools = [];
    let autoAllowTools = [];
    let participants = [];
    let orderOfSpeakers = [];
    let voices = [];
    let roles = [];
    let editingRoleIndex = -1; // -1 means adding new, >= 0 means editing existing
    
    async function loadAgent() {
        try {
            const [agentResponse, modelsResponse] = await Promise.all([
                getAgent(agentName),
                getModels()
            ]);
            
            agentData = agentResponse.agent;
            
            // Populate model dropdown
            const modelSelect = document.getElementById('model-name');
            modelSelect.innerHTML = modelsResponse.model_names.map(name => 
                `<option value="${name}" ${name === agentData.model_name ? 'selected' : ''}>${name}</option>`
            ).join('');
            
            // Populate form fields
            document.getElementById('agent-name').value = agentData.name || agentName;
            document.getElementById('description').value = agentData.description || '';
            document.getElementById('user-name').value = agentData.user_name || '';
            document.getElementById('profile-picture').value = agentData.profile_picture || '';
            document.getElementById('profile-preview').src = agentData.profile_picture || '';
            document.getElementById('temperature').value = agentData.temperature || 0;
            document.getElementById('temp-value').textContent = agentData.temperature || 0;
            document.getElementById('memory').value = agentData.memory || 0;
            document.getElementById('memory-value').textContent = agentData.memory || 0;
            document.getElementById('system-message').value = agentData.system_message || '';
            document.getElementById('bootup-message').value = agentData.bootup_message || '';
            document.getElementById('serendipity-flag').checked = agentData.SERENDIPITY || false;
            document.getElementById('public-flag').checked = agentData.public || false;
            document.getElementById('toolsets').value = (agentData.toolsets || []).join(', ');
            
            // Initialize arrays
            tools = agentData.tools || [];
            autoAllowTools = agentData.auto_allow_tools || [];
            participants = agentData.participants || [];
            orderOfSpeakers = agentData.order_of_speakers || [];
            voices = agentData.voices || [];
            roles = agentData.roles || [];
            
            renderTools();
            renderAutoAllowTools();
            renderParticipants();
            renderSpeakers();
            renderVoices();
            renderRoles();
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('edit-form').classList.remove('hidden');
        } catch (e) {
            console.error('Failed to load agent:', e);
            showToast('Failed to load agent: ' + e.message, 'error');
        }
    }
    
    function renderTools() {
        const container = document.getElementById('tools-list');
        container.innerHTML = tools.map((tool, idx) => `
            <span class="bg-indigo-600 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2">
                ${tool}
                <button onclick="removeTool(${idx})" class="hover:text-red-300">&times;</button>
            </span>
        `).join('');
    }
    
    function renderAutoAllowTools() {
        const container = document.getElementById('auto-allow-tools-list');
        container.innerHTML = autoAllowTools.map((tool, idx) => `
            <span class="bg-emerald-600 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2">
                ${tool}
                <button onclick="removeAutoAllowTool(${idx})" class="hover:text-red-300">&times;</button>
            </span>
        `).join('');
    }
    
    function renderParticipants() {
        const container = document.getElementById('participants-list');
        container.innerHTML = participants.map((p, idx) => `
            <span class="bg-slate-600 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2">
                ${p}
                <button onclick="removeParticipant(${idx})" class="hover:text-red-300">&times;</button>
            </span>
        `).join('');
    }
    
    function renderSpeakers() {
        const container = document.getElementById('speakers-list');
        container.innerHTML = orderOfSpeakers.map((s, idx) => `
            <div class="bg-slate-700 px-4 py-2 rounded-lg flex items-center justify-between speaker-item" draggable="true" data-index="${idx}">
                <div class="flex items-center gap-3">
                    <span class="cursor-grab text-slate-400 hover:text-white drag-handle">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                        </svg>
                    </span>
                    <span>${idx + 1}. ${s}</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="moveSpeakerUp(${idx})" class="text-slate-400 hover:text-white" ${idx === 0 ? 'disabled' : ''}>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                        </svg>
                    </button>
                    <button onclick="moveSpeakerDown(${idx})" class="text-slate-400 hover:text-white" ${idx === orderOfSpeakers.length - 1 ? 'disabled' : ''}>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
        
        // Add drag and drop handlers
        setupSpeakerDragDrop();
    }
    
    function setupSpeakerDragDrop() {
        const container = document.getElementById('speakers-list');
        const items = container.querySelectorAll('.speaker-item');
        
        items.forEach(item => {
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', item.dataset.index);
                item.classList.add('opacity-50');
            });
            
            item.addEventListener('dragend', () => {
                item.classList.remove('opacity-50');
            });
            
            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                item.classList.add('bg-slate-600');
            });
            
            item.addEventListener('dragleave', () => {
                item.classList.remove('bg-slate-600');
            });
            
            item.addEventListener('drop', (e) => {
                e.preventDefault();
                item.classList.remove('bg-slate-600');
                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const toIndex = parseInt(item.dataset.index);
                
                if (fromIndex !== toIndex) {
                    const [moved] = orderOfSpeakers.splice(fromIndex, 1);
                    orderOfSpeakers.splice(toIndex, 0, moved);
                    renderSpeakers();
                }
            });
        });
    }
    
    window.moveSpeakerUp = function(idx) {
        if (idx > 0) {
            [orderOfSpeakers[idx - 1], orderOfSpeakers[idx]] = [orderOfSpeakers[idx], orderOfSpeakers[idx - 1]];
            renderSpeakers();
        }
    };
    
    window.moveSpeakerDown = function(idx) {
        if (idx < orderOfSpeakers.length - 1) {
            [orderOfSpeakers[idx], orderOfSpeakers[idx + 1]] = [orderOfSpeakers[idx + 1], orderOfSpeakers[idx]];
            renderSpeakers();
        }
    };
    
    function renderVoices() {
        const container = document.getElementById('voices-list');
        container.innerHTML = voices.map((v, idx) => `
            <span class="bg-purple-600 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2">
                ${v}
                <button onclick="removeVoice(${idx})" class="hover:text-red-300">&times;</button>
            </span>
        `).join('');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function renderRoles() {
        const container = document.getElementById('roles-list');
        if (roles.length === 0) {
            container.innerHTML = '<p class="text-slate-400">No roles defined</p>';
            return;
        }
        container.innerHTML = roles.map((role, idx) => {
            // Handle both string roles and object roles
            const roleName = typeof role === 'string' ? role : (role.role_name || role.name || 'Unknown');
            const rolePrompt = typeof role === 'object' ? (role.role_prompt || '') : '';
            const escapedPrompt = escapeHtml(rolePrompt);
            return `
                <div class="bg-slate-700 p-4 rounded-lg mb-3">
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-semibold">${escapeHtml(roleName)}</h3>
                        <div class="flex gap-2 flex-shrink-0 ml-4">
                            <button onclick="editRole(${idx})" class="text-indigo-400 hover:text-indigo-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </button>
                            <button onclick="removeRole(${idx})" class="text-red-400 hover:text-red-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    ${rolePrompt ? `<p class="text-sm text-slate-400 whitespace-pre-wrap break-words">${escapedPrompt}</p>` : ''}
                </div>
            `;
        }).join('');
    }
    
    window.addTool = function() {
        const input = document.getElementById('new-tool');
        if (input.value.trim()) {
            tools.push(input.value.trim());
            input.value = '';
            renderTools();
        }
    };
    
    window.removeTool = function(idx) {
        tools.splice(idx, 1);
        renderTools();
    };
    
    window.addAutoAllowTool = function() {
        const input = document.getElementById('new-auto-allow-tool');
        if (input.value.trim()) {
            autoAllowTools.push(input.value.trim());
            input.value = '';
            renderAutoAllowTools();
        }
    };
    
    window.removeAutoAllowTool = function(idx) {
        autoAllowTools.splice(idx, 1);
        renderAutoAllowTools();
    };
    
    window.addParticipant = function() {
        const input = document.getElementById('new-participant');
        if (input.value.trim()) {
            participants.push(input.value.trim());
            if (!orderOfSpeakers.includes(input.value.trim())) {
                orderOfSpeakers.push(input.value.trim());
            }
            input.value = '';
            renderParticipants();
            renderSpeakers();
        }
    };
    
    window.removeParticipant = function(idx) {
        const removed = participants.splice(idx, 1)[0];
        const speakerIdx = orderOfSpeakers.indexOf(removed);
        if (speakerIdx > -1) orderOfSpeakers.splice(speakerIdx, 1);
        renderParticipants();
        renderSpeakers();
    };
    
    window.addVoice = function() {
        const input = document.getElementById('new-voice');
        if (input.value.trim()) {
            voices.push(input.value.trim());
            input.value = '';
            renderVoices();
        }
    };
    
    window.removeVoice = function(idx) {
        voices.splice(idx, 1);
        renderVoices();
    };
    
    window.removeRole = async function(idx) {
        const role = roles[idx];
        const roleName = typeof role === 'string' ? role : (role.role_name || role.name);
        
        if (!confirm(`Are you sure you want to delete the role "${roleName}"?`)) return;
        
        try {
            await editAgentRole(window.currentWif, {
                agent: agentName,
                role_name: roleName,
                action: 'delete'
            });
            roles.splice(idx, 1);
            renderRoles();
            showToast('Role deleted', 'success');
        } catch (e) {
            showToast('Failed to delete role: ' + e.message, 'error');
        }
    };
    
    window.showAddRoleModal = function() {
        editingRoleIndex = -1;
        document.getElementById('role-modal-title').textContent = 'Add Role';
        document.getElementById('role-name').value = '';
        document.getElementById('role-name').readOnly = false;
        document.getElementById('role-system-message').value = '';
        document.getElementById('add-role-modal').classList.remove('hidden');
    };
    
    window.editRole = function(idx) {
        editingRoleIndex = idx;
        const role = roles[idx];
        const roleName = typeof role === 'string' ? role : (role.role_name || role.name || '');
        const rolePrompt = typeof role === 'object' ? (role.role_prompt || '') : '';
        
        document.getElementById('role-modal-title').textContent = 'Edit Role';
        document.getElementById('role-name').value = roleName;
        document.getElementById('role-name').readOnly = true; // Can't change name when editing
        document.getElementById('role-system-message').value = rolePrompt;
        document.getElementById('add-role-modal').classList.remove('hidden');
    };
    
    window.closeAddRoleModal = function() {
        document.getElementById('add-role-modal').classList.add('hidden');
        editingRoleIndex = -1;
    };
    
    window.saveRole = async function() {
        const name = document.getElementById('role-name').value.trim();
        const rolePrompt = document.getElementById('role-system-message').value.trim();
        
        if (!name) {
            showToast('Role name is required', 'error');
            return;
        }
        
        try {
            const action = editingRoleIndex >= 0 ? 'edit' : 'add';
            
            await editAgentRole(window.currentWif, {
                agent: agentName,
                role_name: name,
                role_prompt: rolePrompt,
                action: action
            });
            
            if (editingRoleIndex >= 0) {
                // Update existing role
                roles[editingRoleIndex] = { role_name: name, role_prompt: rolePrompt };
                showToast('Role updated successfully', 'success');
            } else {
                // Add new role
                roles.push({ role_name: name, role_prompt: rolePrompt });
                showToast('Role added successfully', 'success');
            }
            
            renderRoles();
            closeAddRoleModal();
        } catch (e) {
            showToast('Failed to save role: ' + e.message, 'error');
        }
    };
    
    // Upload profile picture
    window.uploadProfilePicture = async function(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        const settings = getSettings();
        
        try {
            showToast('Uploading image...', 'info');
            
            const response = await uploadFile(agentName, file);
            
            if (response.url) {
                // The URL comes with placeholders, use it directly
                document.getElementById('profile-picture').value = response.url;
                
                // For preview, replace placeholders
                const previewUrl = response.url
                    .replace('<serverhost>', settings.serverAddress)
                    .replace('<serverport>', settings.serverPort);
                document.getElementById('profile-preview').src = previewUrl;
                
                showToast('Image uploaded successfully', 'success');
            } else {
                showToast('Upload failed: No URL returned', 'error');
            }
        } catch (e) {
            console.error('Upload failed:', e);
            showToast('Failed to upload image: ' + e.message, 'error');
        }
        
        input.value = ''; // Reset file input
    };
    
    // Upload voice file
    window.uploadVoiceFile = async function(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        const voiceName = prompt('Enter a name for this voice (e.g., "narrator"):');
        
        if (!voiceName) {
            input.value = '';
            return;
        }
        
        try {
            showToast('Uploading voice file...', 'info');
            
            const response = await uploadFile(agentName, file);
            
            if (response.filename) {
                // Add voice in format voice_name:filename
                const voiceEntry = `${voiceName}:${response.filename}`;
                voices.push(voiceEntry);
                renderVoices();
                showToast('Voice file uploaded successfully', 'success');
            } else {
                showToast('Upload failed: No filename returned', 'error');
            }
        } catch (e) {
            console.error('Upload failed:', e);
            showToast('Failed to upload voice file: ' + e.message, 'error');
        }
        
        input.value = ''; // Reset file input
    };
    
    window.saveAgent = async function() {
        const toolsetsStr = document.getElementById('toolsets').value;
        const toolsetsList = toolsetsStr ? toolsetsStr.split(',').map(t => t.trim()).filter(t => t) : [];
        
        const data = {
            agent: agentName,
            description: document.getElementById('description').value,
            user_name: document.getElementById('user-name').value,
            profile_picture: document.getElementById('profile-picture').value,
            model_name: document.getElementById('model-name').value,
            temperature: parseFloat(document.getElementById('temperature').value),
            memory: parseInt(document.getElementById('memory').value),
            system_message: document.getElementById('system-message').value,
            bootup_message: document.getElementById('bootup-message').value,
            serendipity: document.getElementById('serendipity-flag').checked,
            public: document.getElementById('public-flag').checked,
            tools: tools,
            auto_allow_tools: autoAllowTools,
            participants: participants,
            order_of_speakers: orderOfSpeakers,
            voices: voices,
            toolsets: toolsetsList,
            roles: roles
        };
        
        try {
            await editAgent(window.currentWif, data);
            showToast('Agent saved successfully', 'success');
        } catch (e) {
            showToast('Failed to save agent: ' + e.message, 'error');
        }
    };
    
    // Update profile preview when URL changes
    document.getElementById('profile-picture').addEventListener('input', (e) => {
        document.getElementById('profile-preview').src = e.target.value;
    });
    
    // Load agent on page load
    loadAgent();
</script>
{% endblock %}
