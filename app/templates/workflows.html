{% extends "base.html" %}

{% block title %}Workflows - {{ agent_name }} - Serendipity{% endblock %}

{% block content %}
<div class="flex-1 flex flex-col overflow-hidden">
    <!-- Header -->
    <div class="bg-slate-800 border-b border-slate-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/agent/{{ agent_name }}" class="text-slate-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                <h1 class="text-2xl font-bold">Edit workflow</h1>
                <span class="text-slate-400">{{ agent_name }}</span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="runSelectedWorkflow()" class="btn-primary flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Run
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Panel: Workflow Selection & Generation -->
        <div class="w-80 bg-slate-800 border-r border-slate-700 flex flex-col overflow-hidden">
            <!-- Workflow Selection -->
            <div class="p-4 border-b border-slate-700">
                <label class="text-sm text-slate-400 block mb-2">Select Workflow</label>
                <select id="workflow-select" onchange="loadSelectedWorkflow()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <option value="">Please select...</option>
                </select>
            </div>
            
            <!-- Node Selection (shown when workflow selected) -->
            <div id="node-selection" class="p-4 border-b border-slate-700 hidden">
                <label class="text-sm text-slate-400 block mb-2">Select Node to Edit</label>
                <select id="node-select" onchange="loadSelectedNode()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <option value="">Please select...</option>
                </select>
            </div>
            
            <!-- Workflow ID Field -->
            <div class="p-4 border-b border-slate-700">
                <label class="text-sm text-slate-400 block mb-1">Workflow ID</label>
                <input type="text" id="workflow-id-field" placeholder="my-workflow" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
            </div>
            
            <!-- Instructions with Generate Button -->
            <div class="p-4 border-b border-slate-700">
                <label class="text-sm text-slate-400 block mb-1">Instructions</label>
                <div class="flex gap-2">
                    <textarea id="workflow-instructions" rows="3" placeholder="Describe what this workflow should do..." class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm resize-none"></textarea>
                    <button onclick="generateNewWorkflow()" class="btn-secondary p-2 h-fit" title="Generate Workflow">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Flowchart Source -->
            <div class="p-4 flex-1 flex flex-col overflow-hidden">
                <label class="text-sm text-slate-400 block mb-1">Flowchart</label>
                <textarea id="flowchart-code" rows="10" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm font-mono resize-none" placeholder="Mermaid flowchart code..."></textarea>
            </div>
        </div>
        
        <!-- Center Panel: Flowchart Preview -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <div class="p-4 border-b border-slate-700 bg-slate-800/50">
                <h3 class="text-sm font-medium text-slate-300">Flowchart Preview</h3>
            </div>
            <div id="flowchart-container" class="flex-1 overflow-auto p-4 bg-slate-900/50">
                <div id="flowchart-loading" class="text-center py-12 text-slate-500">
                    Select a workflow to view its flowchart
                </div>
                <div id="flowchart-preview" class="hidden"></div>
            </div>
        </div>
        
        <!-- Right Panel: Node Editor (shown when node selected) -->
        <div id="node-editor" class="w-[420px] bg-slate-800 border-l border-slate-700 flex flex-col overflow-hidden hidden">
            <div class="p-4 border-b border-slate-700">
                <h3 class="text-lg font-medium">Edit Node</h3>
                <p id="node-id-display" class="text-sm text-slate-400"></p>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Node Type -->
                <div>
                    <label class="text-sm text-slate-400 block mb-1">Node Type</label>
                    <select id="node-type" onchange="updateNodeTypeFields()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                        <option value="task">Task</option>
                        <option value="action">Action</option>
                    </select>
                </div>
                
                <!-- Next Nodes -->
                <div>
                    <label class="text-sm text-slate-400 block mb-1">Next node(s)</label>
                    <input type="text" id="step-next-nodes" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="node1, node2">
                </div>
                
                <!-- Task Node Fields -->
                <div id="task-fields">
                    <!-- Instructions -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">Instructions</label>
                        <textarea id="step-instructions" rows="5" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm resize-none" placeholder="Enter instructions for this step..."></textarea>
                    </div>
                    
                    <!-- Step Input -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">Step input</label>
                        <textarea id="step-input" rows="5" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm resize-none" placeholder="Define input for this step..."></textarea>
                    </div>
                    
                    <!-- Verification -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">Verification</label>
                        <textarea id="step-verification" rows="5" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm resize-none" placeholder="Verification logic..."></textarea>
                    </div>
                    
                    <!-- Output/InputSchema -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">InputSchema</label>
                        <textarea id="step-output" rows="5" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm resize-none" placeholder="Output/input schema..."></textarea>
                    </div>
                    
                    <!-- Tool (single select) -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">Tool</label>
                        <div class="flex gap-2">
                            <select id="step-tool" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                                <option value="">Please select...</option>
                            </select>
                            <button onclick="clearStepTool()" class="btn-secondary p-2" title="Clear tool">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Roles -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">Roles</label>
                        <div id="step-roles" class="flex flex-wrap gap-2 bg-slate-700 rounded-lg p-2 min-h-[40px]">
                            <span class="text-slate-500 text-sm">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Model -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">Model</label>
                        <select id="step-model" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                            <option value="">Please select...</option>
                        </select>
                    </div>
                    
                    <!-- Temperature (0-1 range) -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">Temperature: <span id="step-temp-value">0.5</span></label>
                        <input type="range" id="step-temperature" min="0" max="1" step="0.01" value="0.5" class="w-full" oninput="document.getElementById('step-temp-value').textContent = parseFloat(this.value).toFixed(2)">
                    </div>
                    
                    <!-- User Name -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">User name</label>
                        <input type="text" id="step-username" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" value="User">
                    </div>
                    
                    <!-- Max Tokens -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">Max tokens</label>
                        <input type="number" id="step-max-tokens" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" value="4094">
                    </div>
                </div>
                
                <!-- Action Node Fields -->
                <div id="action-fields" class="hidden">
                    <!-- Action ID -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">Action id</label>
                        <input type="text" id="step-action-id" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="action_id">
                    </div>
                    
                    <!-- Action Response Template -->
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-1">Action response template</label>
                        <input type="text" id="step-action-response-template" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" value="action response: {response}">
                    </div>
                </div>
                
                <!-- Include Step Outputs (always visible) -->
                <div>
                    <label class="text-sm text-slate-400 block mb-1">Include step outputs</label>
                    <div id="step-available-files" class="flex flex-wrap gap-2 bg-slate-700 rounded-lg p-2 min-h-[40px]">
                        <span class="text-slate-500 text-sm">Select a workflow first</span>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-slate-700">
                <button onclick="saveNodeChanges()" class="btn-primary w-full">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { getWorkflows, getWorkflow, getModels, getAgent, getSettings, saveSettings, startWorkflow, generateWorkflow, editWorkflowStep } from '/static/js/api.js';
    
    const agentName = '{{ agent_name }}';
    const initialWorkflowId = '{{ workflow_id }}';
    const initialNodeId = '{{ node_id }}';
    
    let workflowsData = [];
    let currentWorkflow = null;
    let currentNodeId = null;
    let agentData = null;
    let modelNames = [];
    
    document.addEventListener('DOMContentLoaded', async () => {
        await loadWorkflows();
        await loadModels();
        await loadAgentData();
        updateSidebarAgentInfo();
        
        // Setup flowchart debounce for live preview
        let flowchartDebounce = null;
        document.getElementById('flowchart-code').addEventListener('input', (e) => {
            clearTimeout(flowchartDebounce);
            flowchartDebounce = setTimeout(() => {
                if (e.target.value.trim()) {
                    renderFlowchart(e.target.value);
                }
            }, 2000);
        });
        
        if (initialWorkflowId) {
            document.getElementById('workflow-select').value = initialWorkflowId;
            await loadSelectedWorkflow();
            
            if (initialNodeId) {
                document.getElementById('node-select').value = initialNodeId;
                loadSelectedNode();
            }
        }
    });
    
    async function loadWorkflows() {
        try {
            const data = await getWorkflows(agentName);
            workflowsData = data.workflows || [];
            
            const select = document.getElementById('workflow-select');
            select.innerHTML = '<option value="">Please select...</option>';
            
            workflowsData.forEach(wf => {
                const option = document.createElement('option');
                option.value = wf;
                option.textContent = wf;
                select.appendChild(option);
            });
        } catch (e) {
            console.error('Failed to load workflows:', e);
            showToast('Failed to load workflows', 'error');
        }
    }
    
    async function loadModels() {
        try {
            const data = await getModels();
            modelNames = data.model_names || [];
            
            const select = document.getElementById('step-model');
            select.innerHTML = '<option value="">Please select...</option>';
            
            modelNames.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                select.appendChild(option);
            });
        } catch (e) {
            console.error('Failed to load models:', e);
        }
    }
    
    async function loadAgentData() {
        try {
            agentData = await getAgent(agentName);
            updateToolsAndRoles();
        } catch (e) {
            console.error('Failed to load agent data:', e);
        }
    }
    
    function updateToolsAndRoles() {
        const tools = agentData?.agent?.tools || [];
        const roles = agentData?.agent?.roles || [];
        
        // Populate tool dropdown (single select)
        const toolSelect = document.getElementById('step-tool');
        toolSelect.innerHTML = '<option value="">Please select...</option>';
        tools.forEach(tool => {
            const option = document.createElement('option');
            option.value = tool;
            option.textContent = tool;
            toolSelect.appendChild(option);
        });
        
        // Populate roles checkboxes
        const rolesContainer = document.getElementById('step-roles');
        if (roles.length > 0) {
            rolesContainer.innerHTML = roles.map(role => {
                const roleName = typeof role === 'string' ? role : (role.role_name || role.name || 'Unknown');
                return `
                    <label class="flex items-center gap-1 cursor-pointer text-sm">
                        <input type="checkbox" value="${roleName}" class="w-4 h-4 rounded">
                        <span>${roleName}</span>
                    </label>
                `;
            }).join('');
        } else {
            rolesContainer.innerHTML = '<span class="text-slate-500 text-sm">No roles available</span>';
        }
    }
    
    function updateAvailableFilesCheckboxes() {
        const container = document.getElementById('step-available-files');
        if (!currentWorkflow || !currentWorkflow.nodes) {
            container.innerHTML = '<span class="text-slate-500 text-sm">Select a workflow first</span>';
            return;
        }
        
        const nodeIds = Object.keys(currentWorkflow.nodes);
        if (nodeIds.length === 0) {
            container.innerHTML = '<span class="text-slate-500 text-sm">No nodes available</span>';
            return;
        }
        
        container.innerHTML = nodeIds.map(nodeId => `
            <label class="flex items-center gap-1 cursor-pointer text-sm">
                <input type="checkbox" value="${nodeId}" class="available-file-checkbox w-4 h-4 rounded">
                <span>${nodeId}</span>
            </label>
        `).join('');
    }
    
    window.updateNodeTypeFields = function() {
        const nodeType = document.getElementById('node-type').value;
        const taskFields = document.getElementById('task-fields');
        const actionFields = document.getElementById('action-fields');
        
        if (nodeType === 'task') {
            taskFields.classList.remove('hidden');
            actionFields.classList.add('hidden');
        } else {
            taskFields.classList.add('hidden');
            actionFields.classList.remove('hidden');
        }
    };
    
    window.clearStepTool = function() {
        document.getElementById('step-tool').value = '';
    };
    
    window.loadSelectedWorkflow = async function() {
        const workflowId = document.getElementById('workflow-select').value;
        
        if (!workflowId) {
            currentWorkflow = null;
            document.getElementById('node-selection').classList.add('hidden');
            document.getElementById('node-editor').classList.add('hidden');
            document.getElementById('flowchart-preview').classList.add('hidden');
            document.getElementById('flowchart-loading').classList.remove('hidden');
            document.getElementById('flowchart-code').value = '';
            document.getElementById('workflow-id-field').value = '';
            return;
        }
        
        try {
            const data = await getWorkflow(agentName, workflowId);
            currentWorkflow = data.workflow || data;
            
            // Update URL
            window.history.replaceState({}, '', `/agent/${encodeURIComponent(agentName)}/workflows?workflow_id=${encodeURIComponent(workflowId)}`);
            
            // Update workflow ID field
            document.getElementById('workflow-id-field').value = workflowId;
            
            // Populate node dropdown
            const nodeSelect = document.getElementById('node-select');
            nodeSelect.innerHTML = '<option value="">Please select...</option>';
            
            const nodeIds = currentWorkflow.nodeIds || currentWorkflow.node_ids || [];
            nodeIds.forEach(nodeId => {
                const option = document.createElement('option');
                option.value = nodeId;
                option.textContent = nodeId;
                nodeSelect.appendChild(option);
            });
            
            document.getElementById('node-selection').classList.remove('hidden');
            
            // Display flowchart
            const flowchart = currentWorkflow.flowchart || '';
            document.getElementById('flowchart-code').value = flowchart;
            
            if (flowchart) {
                renderFlowchart(flowchart);
            } else {
                document.getElementById('flowchart-preview').classList.add('hidden');
                document.getElementById('flowchart-loading').textContent = 'No flowchart defined for this workflow';
                document.getElementById('flowchart-loading').classList.remove('hidden');
            }
            
            // Update available files checkboxes
            updateAvailableFilesCheckboxes();
            
        } catch (e) {
            console.error('Failed to load workflow:', e);
            showToast('Failed to load workflow', 'error');
        }
    };
    
    async function renderFlowchart(code) {
        const container = document.getElementById('flowchart-preview');
        const loading = document.getElementById('flowchart-loading');
        
        try {
            loading.classList.add('hidden');
            container.classList.remove('hidden');
            
            const id = `flowchart-${Date.now()}`;
            const { svg } = await mermaid.render(id, code);
            container.innerHTML = svg;
        } catch (e) {
            console.error('Mermaid render error:', e);
            container.innerHTML = `<pre class="text-red-400 text-sm">Flowchart error: ${e.message}</pre>`;
        }
    }
    
    window.loadSelectedNode = function() {
        const nodeId = document.getElementById('node-select').value;
        
        if (!nodeId || !currentWorkflow) {
            document.getElementById('node-editor').classList.add('hidden');
            currentNodeId = null;
            return;
        }
        
        currentNodeId = nodeId;
        
        // Update URL
        const workflowId = document.getElementById('workflow-select').value;
        window.history.replaceState({}, '', `/agent/${encodeURIComponent(agentName)}/workflows?workflow_id=${encodeURIComponent(workflowId)}&node_id=${encodeURIComponent(nodeId)}`);
        
        // Find node data
        const nodes = currentWorkflow.nodes || {};
        const node = nodes[nodeId] || {};
        
        // Populate editor - common fields
        document.getElementById('node-id-display').textContent = `Node: ${nodeId}`;
        document.getElementById('node-type').value = node.node_type || node.nodeType || 'task';
        document.getElementById('step-next-nodes').value = (node.next_nodes || node.nextNodes || []).join(', ');
        
        // Task fields
        document.getElementById('step-instructions').value = node.instructions || '';
        document.getElementById('step-input').value = node.input || '';
        document.getElementById('step-verification').value = node.verification || '';
        document.getElementById('step-output').value = node.output || '';
        document.getElementById('step-tool').value = node.step_tool || node.stepTool || '';
        document.getElementById('step-model').value = node.model_name || node.modelName || '';
        document.getElementById('step-temperature').value = node.temperature ?? 0.5;
        document.getElementById('step-temp-value').textContent = (node.temperature ?? 0.5).toFixed(2);
        document.getElementById('step-username').value = node.user_name || node.userName || 'User';
        document.getElementById('step-max-tokens').value = node.max_tokens || node.maxTokens || 4094;
        
        // Action fields
        document.getElementById('step-action-id').value = node.action_id || node.actionId || '';
        document.getElementById('step-action-response-template').value = node.action_response_template || node.actionResponseTemplate || 'action response: {response}';
        
        // Check roles
        const nodeRoles = node.available_roles || node.availableRoles || [];
        document.querySelectorAll('#step-roles input[type="checkbox"]').forEach(cb => {
            cb.checked = nodeRoles.includes(cb.value);
        });
        
        // Check available files (include step outputs)
        const nodeFiles = node.available_files || node.availableFiles || [];
        document.querySelectorAll('#step-available-files input[type="checkbox"]').forEach(cb => {
            cb.checked = nodeFiles.includes(cb.value);
        });
        
        // Show/hide fields based on node type
        updateNodeTypeFields();
        
        document.getElementById('node-editor').classList.remove('hidden');
    };
    
    window.saveNodeChanges = async function() {
        if (!currentWorkflow || !currentNodeId) {
            showToast('No node selected', 'error');
            return;
        }
        
        const workflowId = document.getElementById('workflow-select').value;
        const nodeId = currentNodeId;
        const nodeType = document.getElementById('node-type').value;
        
        const selectedRoles = Array.from(document.querySelectorAll('#step-roles input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedFiles = Array.from(document.querySelectorAll('#step-available-files input[type="checkbox"]:checked')).map(cb => cb.value);
        const nextNodes = document.getElementById('step-next-nodes').value.split(',').map(s => s.trim()).filter(s => s);
        
        // Build data object matching Flutter Flow structure
        const data = {
            agent: agentName,
            workflow_id: workflowId,
            node_id: nodeId,
            node_type: nodeType,
            next_nodes: nextNodes,
            available_roles: selectedRoles,
            available_files: selectedFiles
        };
        
        if (nodeType === 'task') {
            data.instructions = document.getElementById('step-instructions').value;
            data.input = document.getElementById('step-input').value;
            data.verification = document.getElementById('step-verification').value;
            data.output = document.getElementById('step-output').value;
            data.step_tool = document.getElementById('step-tool').value || null;
            data.model_name = document.getElementById('step-model').value;
            data.temperature = parseFloat(document.getElementById('step-temperature').value);
            data.user_name = document.getElementById('step-username').value;
            data.max_tokens = parseInt(document.getElementById('step-max-tokens').value) || 4094;
        } else {
            data.action_id = document.getElementById('step-action-id').value;
            data.action_response_template = document.getElementById('step-action-response-template').value;
        }
        
        try {
            await editWorkflowStep(window.currentWif, data);
            
            showToast('Workflow step saved successfully', 'success');
            
            // Reload workflow and navigate back to same node
            await loadSelectedWorkflow();
            document.getElementById('node-select').value = nodeId;
            loadSelectedNode();
            
        } catch (e) {
            console.error('Failed to save node:', e);
            showToast('Failed to edit workflow step', 'error');
        }
    };
    
    window.generateNewWorkflow = async function() {
        const workflowId = document.getElementById('workflow-id-field').value.trim();
        const instructions = document.getElementById('workflow-instructions').value.trim();
        const flowchart = document.getElementById('flowchart-code').value.trim();
        
        if (!workflowId) {
            showToast('Please enter a workflow ID', 'error');
            return;
        }
        
        if (!instructions) {
            showToast('Please enter instructions', 'error');
            return;
        }
        
        try {
            showToast('Generating workflow...', 'info');
            
            // Match Flutter Flow: include modelName and flowchart
            const settings = getSettings();
            await generateWorkflow(window.currentWif, {
                agent: agentName,
                workflow_id: workflowId,
                instructions: instructions,
                model_name: settings.modelName || '',
                flowchart: flowchart
            });
            
            showToast('Workflow saved successfully', 'success');
            
            // Reload workflows and select the new one
            await loadWorkflows();
            document.getElementById('workflow-select').value = workflowId;
            await loadSelectedWorkflow();
            
            // Clear instructions
            document.getElementById('workflow-instructions').value = '';
            
        } catch (e) {
            console.error('Failed to generate workflow:', e);
            showToast('Failed to edit workflow', 'error');
        }
    };
    
    window.runSelectedWorkflow = async function() {
        const workflowId = document.getElementById('workflow-select').value;
        
        if (!workflowId) {
            showToast('Please select a workflow', 'error');
            return;
        }
        
        try {
            showToast('Starting workflow...', 'info');
            
            // Match Flutter Flow: set folder to 'workflows'
            const response = await startWorkflow(window.currentWif, {
                agent: agentName,
                folder_name: 'workflows',
                workflow_id: workflowId,
                workflow_input: '',
                conversation_id: ''
            });
            
            if (response.conversation_id) {
                // Update app state like Flutter Flow does
                const conversation = response.conversation || {};
                
                localStorage.setItem('serendipity_folder_name', 'workflows');
                saveSettings({ folderName: 'workflows' });
                
                // Store conversation state
                if (conversation.enabled_tools) {
                    let enabledTools = conversation.enabled_tools;
                    if (!enabledTools.includes('workflow')) {
                        enabledTools.push('workflow');
                    }
                    localStorage.setItem('serendipity_enabled_tools', JSON.stringify(enabledTools));
                }
                if (conversation.enabled_roles) {
                    localStorage.setItem('serendipity_enabled_roles', JSON.stringify(conversation.enabled_roles));
                }
                if (conversation.model_name) {
                    localStorage.setItem('serendipity_model_name', conversation.model_name);
                }
                if (conversation.temperature !== undefined) {
                    localStorage.setItem('serendipity_temperature', conversation.temperature);
                }
                if (conversation.user_name) {
                    localStorage.setItem('serendipity_user_name', conversation.user_name);
                }
                if (conversation.open_files) {
                    localStorage.setItem('serendipity_open_files', JSON.stringify(conversation.open_files));
                }
                if (conversation.participants) {
                    localStorage.setItem('serendipity_participants', JSON.stringify(conversation.participants));
                }
                
                showToast('Workflow started', 'success');
                // Navigate to conversation
                window.location.href = `/agent/${encodeURIComponent(agentName)}/conversation?conversation_id=${encodeURIComponent(response.conversation_id)}`;
            } else {
                showToast('Failed to start workflow', 'error');
            }
            
        } catch (e) {
            console.error('Failed to start workflow:', e);
            showToast('Failed to start workflow', 'error');
        }
    };
    
    function updateSidebarAgentInfo() {
        const settings = getSettings();
        const agentInfo = document.getElementById('agent-info');
        const agentAvatar = document.getElementById('agent-avatar');
        const agentNameDisplay = document.getElementById('agent-name-display');
        const agentDescDisplay = document.getElementById('agent-description-display');
        
        // Save current agent to settings
        saveSettings({ agentName: agentName });
        
        // Show agent info section
        agentInfo.classList.remove('hidden');
        agentNameDisplay.textContent = agentName;
        agentDescDisplay.textContent = localStorage.getItem('serendipity_agent_description') || '';
        
        // Load profile image from localStorage (stored with placeholders)
        const profileImage = localStorage.getItem('serendipity_agent_profile_image');
        if (profileImage) {
            const imgUrl = profileImage
                .replace('<serverhost>', settings.serverAddress)
                .replace('<serverport>', settings.serverPort);
            agentAvatar.src = imgUrl;
        }
        
        // Update navigation links
        if (typeof updateNavigation === 'function') {
            updateNavigation();
        }
    }
</script>
{% endblock %}
